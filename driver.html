<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Driver - Enviar ubicación</title>
</head>
<body>
  <h3>Conductor — Enviar ubicación a Google Sheets</h3>
  <label>Driver ID: <input id="driverId" value="driver1" /></label>
  <button id="start">Start</button>
  <button id="stop" disabled>Stop</button>
  <p id="status">Stopped</p>

  <script>
    const WEBAPP_URL = "https://script.google.com/macros/s/AKfycby9MrnrXbwlp3gey_oKdTHE0KUjWVoNMk6aEIXF7I7Mzg2Fpjogt2nr2xqambCMVb7g-w/exec";

    let watchId = null;
    let lastSent = 0;
    let lastPos = null;
//    const MIN_INTERVAL_MS = 3000; // enviar máximo cada 3s
//    const MIN_DISTANCE_M = 10;    // o solo si se movió >10 m
    
    const MIN_INTERVAL_MS = 0; // enviar cada lectura durante pruebas
    const MIN_DISTANCE_M = 0;  // enviar aunque no se mueva (pruebas)
    
    function distanceMeters(lat1, lon1, lat2, lon2) {
      function toRad(v){return v * Math.PI/180;}
      const R = 6371000;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)*Math.sin(dLon/2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
      return R * c;
    }

    // Envía datos usando una petición GET tipo "beacon" mediante Image
    function sendBeacon(params) {
      // params: object con driver_id, lat, lon, speed, ts
      const qp = new URLSearchParams(params).toString();
      // Añadir un cache-buster
      const img = new Image();
      img.src = WEBAPP_URL + "?" + qp + "&_=" + Date.now();
      // No necesitamos manejar onload/onerror; si falla, se ignora
    }

    document.getElementById('start').onclick = () => {
      const driverId = (document.getElementById('driverId').value || 'driver1').trim();
      if (!('geolocation' in navigator)) {
        alert('Geolocation no soportado');
        return;
      }
      document.getElementById('status').textContent = 'Solicitando ubicación...';

      watchId = navigator.geolocation.watchPosition(pos => {
        const now = Date.now();
        const payload = {
          driver_id: driverId,
          lat: pos.coords.latitude,
          lon: pos.coords.longitude,
          speed: pos.coords.speed || 0,
          ts: pos.timestamp || now
        };
        const timeOk = (now - lastSent) > MIN_INTERVAL_MS;
        const distOk = !lastPos || distanceMeters(lastPos.lat, lastPos.lon, payload.lat, payload.lon) > MIN_DISTANCE_M;
        if (timeOk && distOk) {
          sendBeacon(payload);
          lastSent = now;
          lastPos = {lat: payload.lat, lon: payload.lon};
          document.getElementById('status').textContent = 'Enviado: ' + new Date(now).toLocaleTimeString();
        } else {
          document.getElementById('status').textContent = 'Saltado (throttle)';
        }
      }, err => {
        console.error('geo error', err);
        document.getElementById('status').textContent = 'Geo error: ' + err.message;
      }, { enableHighAccuracy: true, maximumAge: 1000, timeout: 10000 });

      document.getElementById('start').disabled = true;
      document.getElementById('stop').disabled = false;
    };

    document.getElementById('stop').onclick = () => {
      if (watchId !== null) navigator.geolocation.clearWatch(watchId);
      watchId = null;
      document.getElementById('status').textContent = 'Stopped';
      document.getElementById('start').disabled = false;
      document.getElementById('stop').disabled = true;
    };
  </script>
</body>
</html>


